---
title: "DevPodでPodmanを快適に！Podman Providerを開発した話"
emoji: "🦭"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["DevPod", "Podman", "devcontainer", "ClaudeCode"]
published: true
---

## はじめに

DevPodは、開発環境をコンテナ（devcontainer）としてローカルやクラウドに構築できる強力なツールです。しかし、Podmanユーザー、特にMacやWindowsでPodman Machineを利用している環境では、既存のDocker Providerを使う際にいくつかの課題がありました。

そこで今回、Podmanに最適化された「Podman Provider」を開発しました。本記事では、その背景、特徴、そしてClaude Codeを活用した爆速開発の裏側について紹介します。

## DevPodとはなにか

- devcontainerの仕様に基づいた開発環境構築ツール
  - VSCodeのdevcontainer拡張機能がdevconainerの仕様に沿ったツールとして利用されることが多いが、内部は非公開かつOpenVSXマーケットプレイスに公開されていないため、ほかのVSCodeベースのエディタ（VSCodium, Cursor, IBM Bob, etc...）では利用できない
- IDE（VS Code, Cursor, JetBrains等）との親和性が高い
- プロバイダー方式により、バックエンドを選ばない（Docker, K8s, SSH, etc...）
  - 自作することも可能であるため、企業内クラウドなど制約がある環境でも利用できる

## Podman Providerが必要になった背景

Podman Providerを開発することにしたきっかけは、私自身がMac上でPodman Machineを使用して開発を行っており、これをIBM Bob（VSCodiumベースのエディタ）で利用したいと考えたことでした。
IBM BobではOpenVSXマーケットプレイスしか利用できないため、VSCodeのdevcontainer拡張機能を利用できません。そのため、DevPodを使ってPodmanベースのdevcontainer環境を構築する必要がありました。

しかし、既存のDocker Providerを使うと以下のような問題が発生しました。

1. **Rootless環境への対応**: Docker ProviderではRootless環境ではソケットがdocker.sockではなくPodman固有のパスになるため、Podman Machineを起動するたびに設定変更が必要だった
2. **互換性設定の依存**: デフォルトではPodman Desktopの「docker compatible」設定を有効にする必要があった
3. **VM管理の自動化**: Mac/Windows環境において、Podman Machineの起動・初期化をDevPod側から制御したかった

そのため、Podmanに特化したProviderを開発することにしました。

## Podman Providerの特徴と使い方

https://github.com/kuju63/devpod-provider-podman

### 主な機能

- **Podman Machineの自動管理**
  - Podman Machineが停止していれば自動起動
  - これにより、DevPodだけでPodman Machineも管理できるように
- **リソースのホットリロード**
  - Podman MachineのCPU/Memory/DiskサイズをDevPodのプロバイダー設定から変更可能
  - 変更して保存するだけで、Podman Machineに反映
- **セキュアな設定**
  - Rootless環境をデフォルトでサポート
  - 通常の開発ではRootfulである必要はあまりないため、Rootlessをデフォルトに設定

### 使い方

DevPodのダッシュボードからでも利用できますが、CLIからも簡単にセットアップできます。

```bash
# devpodへのPodman Providerの追加
devpod provider add https://github.com/kuju63/devpod-provider-podman
# Podman Providerを使ってdevcontainer環境を起動
devpod up . --provider podman
```

## 開発の裏側：Claude Codeとの共同開発

今回開発からリリースまで実質2日足らずのスピードで進めることができました。これは、Claude Codeを活用することで実現できました。

具体的には、以下のような点でClaude Codeを活用しました。

1. **Planモードでの構想からの調査**: DevPodのProvider開発に必要な情報収集や実装方法の調査をPlanモードで行い、効率的に設計を進めることができました。
2. **ドキュメントとしてのIssue作成**: Planモードで得た情報から必ずIssueを作成することで、タスクの明確化とハルシネーションの予防に役立ちました。
3. **実装コードの生成**: 実際のコード実装部分もClaude Codeに任せることで、DevPodのProvider仕様やPodman特有のポイントを効率的にクリアできました。今回のコードのほぼすべてはClaude Codeが生成したものになります。

一方で、Claude Codeがきちんと意図したとおりに動作するようにするために、以下の工夫も行いました。

1. **情報の裏取り**: Claude Codeが誤った情報を元にして判断していないかを確認するために、重要な部分では公式ドキュメントを確認しています。
2. **ゴールの明確化**: 実際の期待する動作やテストケースを明確に提示することで、Claude Codeが正しい方向に進むようにしました。また、テストスクリプトを`/tmp`に出力することが多いですが、これを避けるように指示しました。
3. **CLAUDE.mdの充実**: これまでの経験や工夫を元にCLAUDE.mdを作成し、開発者が意図した順番で開発を進めるようにルール付けをしました。

これらの中でも特に「Planモードでの構想からの調査」と「CLAUDE.mdの充実」が重要であると感じました。きちんと事前にガードレールを設けることで、Claude Codeの力を最大限に引き出すことができました。

## 今後追加したい機能について

現在はmacOS向けに開発していますが、今後はWindows環境でのサポートも強化していく予定です。

1. Windows環境でのPodman Machine管理の実装
2. より詳細なVM設定（ネットワーク共有、マウント設定等）のサポート
3. Podman-Composeを使用した複数コンテナ環境のサポート

## まとめ

Docker Desktopが利用できない環境や、AI開発ツールを使用する方にとって、Podman + DevPodの組み合わせは強力な選択肢になります。ぜひ試してみてください！
