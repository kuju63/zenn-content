---
title: "DevPodでPodmanを快適に！Podman Providerを開発した話"
emoji: "🦭"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["DevPod", "Podman", "devcontainer", "ClaudeCode"]
published: true
---

## はじめに

[DevPod](https://devpod.sh/)は、開発環境をコンテナ（[devcontainer](https://containers.dev/)）としてローカルやクラウドに構築できる強力なツールです。しかし、[Podman](https://podman.io/)ユーザー、特にMacやWindowsでPodman Machineを利用している環境では、既存のDocker Providerを使う際にいくつかの課題がありました。

そこで今回、Podmanに最適化された「Podman Provider」を開発しました。本記事では、その背景、特徴、そしてClaude Codeを活用した爆速開発の裏側について紹介します。

## この記事の対象読者

- Podmanを使っている、または導入を検討している開発者
- DevPodに興味がある方
- VSCode以外のエディタ（Cursor、IBM Bob等）でdevcontainer環境を使いたい方

**前提知識**: コンテナとdevcontainerの基本的な概念を理解していることを前提としています。

## DevPodとはなにか

DevPodは、開発環境をコンテナで管理するためのオープンソースツールです。

### 特徴

- **devcontainerの仕様に基づいた開発環境構築ツール**
  - VSCodeのdevcontainer拡張機能と同等の機能を提供
  - VSCodeのdevcontainer拡張機能は内部が非公開で、OpenVSXマーケットプレイスに公開されていないため、他のVSCodeベースのエディタ（VSCodium、Cursor、IBM Bob等）では利用できない問題がある
  - DevPodはこの問題を解決し、どのエディタでもdevcontainer環境を利用可能にする
- **IDE（VS Code, Cursor, JetBrains等）との親和性が高い**
  - 各IDEのプラグインが提供されている
- **プロバイダー方式により、バックエンドを選ばない**
  - Docker、Kubernetes、SSH、クラウドプロバイダーなど様々な環境で動作
  - 自作プロバイダーの開発も可能で、企業内クラウドなど制約がある環境でも利用できる

参考: [DevPod公式サイト](https://devpod.sh/)

## Podman Providerが必要になった背景

Podman Providerを開発することにしたきっかけは、私自身がMac上でPodman Machineを使用して開発を行っており、これをIBM Bob（VSCodiumベースのエディタ）で利用したいと考えたことでした。
IBM BobではOpenVSXマーケットプレイスしか利用できないため、VSCodeのdevcontainer拡張機能を利用できません。そのため、DevPodを使ってPodmanベースのdevcontainer環境を構築する必要がありました。

しかし、既存のDocker Providerを使うと以下のような問題が発生しました。

1. **Rootless環境への対応**
   - Docker Providerでは `DOCKER_HOST` 環境変数を `unix:///var/run/docker.sock` に設定することを前提としている
   - しかしPodman MachineのRootless環境では、ソケットパスが `/run/user/1000/podman/podman.sock` のようなユーザー固有のパスになる
   - Podman Machineを再起動するたびに、DevPodの設定で環境変数を手動で変更する必要があった

2. **互換性設定の依存**
   - Docker Providerを使う場合、Podman DesktopまたはPodman Machineで `docker.sock` へのシンボリックリンクを作成する必要があった
   - この設定を忘れると、DevPodが「Docker daemonに接続できません」というエラーを出す

3. **VM管理の自動化**
   - Podman Machineが停止していると、DevPodの起動時にエラーになる
   - 手動で `podman machine start` を実行してからDevPodを起動する必要があった

そのため、Podmanに特化したProviderを開発することにしました。

## Podman Providerの特徴と使い方

https://github.com/kuju63/devpod-provider-podman

### 主な機能

- **Podman Machineの自動管理**
  - Podman Machineが停止していれば自動起動
  - これにより、DevPodだけでPodman Machineも管理できるように
- **リソースのホットリロード**
  - Podman MachineのCPU/Memory/DiskサイズをDevPodのプロバイダー設定から変更可能
  - 変更して保存するだけで、Podman Machineに反映
- **セキュアな設定**
  - Rootless環境をデフォルトでサポート
  - 通常の開発ではRootfulである必要はあまりないため、Rootlessをデフォルトに設定

### 使い方

DevPodのダッシュボードからでも利用できますが、CLIからも簡単にセットアップできます。

```bash
# devpodへのPodman Providerの追加
devpod provider add https://github.com/kuju63/devpod-provider-podman
# Podman Providerを使ってdevcontainer環境を起動
devpod up . --provider podman
```

## 開発の裏側：Claude Codeとの共同開発

今回開発からリリースまで実質2日足らずのスピードで進めることができました。これは、Claude Codeを活用することで実現できました。

具体的には、以下のような点でClaude Codeを活用しました。

1. **Planモードでの構想からの調査**: DevPodのProvider開発に必要な情報収集や実装方法の調査をPlanモードで行い、効率的に設計を進めることができました。
2. **ドキュメントとしてのIssue作成**: Planモードで得た情報から必ずIssueを作成することで、タスクの明確化とハルシネーションの予防に役立ちました。
3. **実装コードの生成**: 実際のコード実装部分もClaude Codeに任せることで、DevPodのProvider仕様やPodman特有のポイントを効率的にクリアできました。今回のコードのほぼすべてはClaude Codeが生成したものになります。

一方で、Claude Codeがきちんと意図したとおりに動作するようにするために、以下の工夫も行いました。

1. **情報の裏取り**: Claude Codeが誤った情報を元にして判断していないかを確認するために、重要な部分では公式ドキュメントを確認しています。
2. **ゴールの明確化**: 実際の期待する動作やテストケースを明確に提示することで、Claude Codeが正しい方向に進むようにしました。また、テストスクリプトを`/tmp`に出力することが多いですが、これを避けるように指示しました。
3. **CLAUDE.mdの充実**: これまでの経験や工夫を元にCLAUDE.mdを作成し、開発者が意図した順番で開発を進めるようにルール付けをしました。

これらの中でも特に「Planモードでの構想からの調査」と「CLAUDE.mdの充実」が重要であると感じました。きちんと事前にガードレールを設けることで、Claude Codeの力を最大限に引き出すことができました。

## 今後追加したい機能について

現在はmacOS向けに開発していますが、今後はWindows環境でのサポートも強化していく予定です。

1. Windows環境でのPodman Machine管理の実装
2. より詳細なVM設定（ネットワーク共有、マウント設定等）のサポート
3. Podman-Composeを使用した複数コンテナ環境のサポート

## まとめ

Podman Providerは、以下のような方におすすめです:

- **Docker Desktopの代替を探している方**: ライセンス費用を気にせず、オープンソースで開発環境を構築したい
- **VSCode以外のエディタを使いたい方**: Cursor、IBM Bob、VSCodiumなどでdevcontainer環境を利用したい
- **Rootlessコンテナを活用したい方**: セキュリティを重視した開発環境を構築したい
- **Podman Machineの管理を自動化したい方**: 毎回手動で起動するのが面倒だと感じている

Podman + DevPodの組み合わせは、モダンな開発環境を柔軟に構築できる強力な選択肢です。特にAI開発ツールを活用する環境では、オープンソースで制約の少ないツールチェーンの重要性が高まっています。

ぜひGitHubリポジトリをスターして、フィードバックやコントリビューションをお待ちしています！

https://github.com/kuju63/devpod-provider-podman
